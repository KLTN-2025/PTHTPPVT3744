<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Thanh toán</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f8f9fa;
      color: #333;
      min-height: 100vh;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 20px;
    }

    /* Breadcrumb */
    .breadcrumb-section {
      background: white;
      padding: 20px 0;
      border-bottom: 1px solid #e0e0e0;
      margin-bottom: 30px;
    }

    .breadcrumb {
      list-style: none;
      display: flex;
      gap: 10px;
      font-size: 14px;
    }

    .breadcrumb li:not(:last-child)::after {
      content: '/';
      margin-left: 10px;
      color: #999;
    }

    .breadcrumb a {
      color: #0066cc;
      text-decoration: none;
    }

    /* Page Title */
    .page-title {
      background: white;
      padding: 30px 0;
      margin-bottom: 30px;
    }

    .page-title h1 {
      font-size: 32px;
      font-weight: 700;
      margin-bottom: 10px;
    }

    /* Checkout Layout */
    .checkout-layout {
      display: grid;
      grid-template-columns: 1fr 400px;
      gap: 30px;
      margin-bottom: 50px;
    }

    /* Form Section */
    .form-section {
      background: white;
      border-radius: 10px;
      padding: 25px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }

    .section-title {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid #e0e0e0;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .section-title i {
      color: #0066cc;
    }

    /* Address Selection */
    .address-list {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .address-item {
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      padding: 15px;
      cursor: pointer;
      transition: all 0.3s;
      position: relative;
    }

    .address-item:hover {
      border-color: #0066cc;
      background: #f8f9fa;
    }

    .address-item.selected {
      border-color: #0066cc;
      background: #e8f4ff;
    }

    .address-item input[type="radio"] {
      position: absolute;
      top: 15px;
      right: 15px;
    }

    .address-name {
      font-weight: 600;
      margin-bottom: 5px;
    }

    .address-phone {
      color: #666;
      font-size: 14px;
      margin-bottom: 5px;
    }

    .address-detail {
      color: #333;
      font-size: 14px;
    }

    .address-default {
      display: inline-block;
      background: #4CAF50;
      color: white;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 11px;
      margin-left: 10px;
    }

    /* New Address Form */
    .new-address-form {
      display: none;
      margin-top: 20px;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 8px;
    }

    .new-address-form.active {
      display: block;
    }

    .form-group {
      margin-bottom: 15px;
    }

    .form-group label {
      display: block;
      font-weight: 600;
      margin-bottom: 5px;
      font-size: 14px;
    }

    .form-group input,
    .form-group textarea,
    .form-group select {
      width: 100%;
      padding: 10px;
      border: 1px solid #e0e0e0;
      border-radius: 5px;
      font-size: 14px;
    }

    .form-group textarea {
      resize: vertical;
      min-height: 80px;
    }

    .btn-add-address {
      background: #0066cc;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
    }

    .btn-add-address:hover {
      background: #0052a3;
    }

    /* Payment Methods */
    .payment-methods {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .payment-item {
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      padding: 15px;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .payment-item:hover {
      border-color: #0066cc;
      background: #f8f9fa;
    }

    .payment-item.selected {
      border-color: #0066cc;
      background: #e8f4ff;
    }

    .payment-item input[type="radio"] {
      width: 20px;
      height: 20px;
    }

    .payment-icon {
      width: 50px;
      height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #f8f9fa;
      border-radius: 8px;
    }

    .payment-icon i {
      font-size: 24px;
    }

    .payment-info {
      flex: 1;
    }

    .payment-name {
      font-weight: 600;
      margin-bottom: 5px;
    }

    .payment-desc {
      font-size: 13px;
      color: #666;
    }

    /* Coupon Input */
    .coupon-section {
      display: flex;
      gap: 10px;
      margin: 15px 0;
    }

    .coupon-input {
      flex: 1;
      padding: 10px;
      border: 1px solid #e0e0e0;
      border-radius: 5px;
      font-size: 14px;
    }

    .btn-apply-coupon {
      padding: 10px 20px;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
    }

    .btn-apply-coupon:hover {
      background: #45a049;
    }

    /* Loyalty Points */
    .loyalty-section {
      background: #fff8e1;
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
    }

    .loyalty-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .loyalty-checkbox {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 10px;
    }

    .loyalty-input {
      width: 100px;
      padding: 8px;
      border: 1px solid #e0e0e0;
      border-radius: 5px;
    }

    /* Order Summary */
    .order-summary {
      background: white;
      border-radius: 10px;
      padding: 25px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      position: sticky;
      top: 90px;
      max-height: calc(100vh - 120px);
      overflow-y: auto;
    }

    .summary-title {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid #e0e0e0;
    }

    .summary-items {
      max-height: 300px;
      overflow-y: auto;
      margin-bottom: 20px;
      padding-right: 10px;
    }

    .summary-item {
      display: flex;
      gap: 15px;
      padding: 15px 0;
      border-bottom: 1px solid #f0f0f0;
    }

    .summary-item:last-child {
      border-bottom: none;
    }

    .item-image {
      width: 60px;
      height: 60px;
      border-radius: 5px;
      overflow: hidden;
      border: 1px solid #e0e0e0;
    }

    .item-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .item-details {
      flex: 1;
    }

    .item-name {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 5px;
    }

    .item-qty {
      font-size: 13px;
      color: #666;
    }

    .item-price {
      font-size: 14px;
      font-weight: 600;
      color: #ff4444;
      text-align: right;
    }

    .summary-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 15px;
      font-size: 15px;
    }

    .summary-row.total {
      font-size: 20px;
      font-weight: bold;
      color: #ff4444;
      padding-top: 15px;
      border-top: 2px solid #e0e0e0;
      margin-top: 15px;
    }

    .discount-note {
      color: #4CAF50;
      font-size: 13px;
      margin-top: 5px;
    }

    .btn-place-order {
      width: 100%;
      padding: 15px;
      background: #ff4444;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      margin-top: 20px;
    }

    .btn-place-order:hover:not(:disabled) {
      background: #cc0000;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(255, 68, 68, 0.3);
    }

    .btn-place-order:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    /* Loading Overlay */
    .loading-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      z-index: 9999;
      justify-content: center;
      align-items: center;
    }

    .loading-overlay.active {
      display: flex;
    }

    .loading-spinner {
      border: 5px solid #f3f3f3;
      border-top: 5px solid #0066cc;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Notification Toast */
    .notification-toast {
      position: fixed;
      top: 80px;
      right: 20px;
      background: white;
      padding: 15px 20px;
      border-radius: 8px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.3);
      z-index: 10000;
      display: flex;
      align-items: center;
      gap: 15px;
      min-width: 300px;
      animation: slideInRight 0.3s ease-out;
    }

    @keyframes slideInRight {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    @keyframes slideOutRight {
      from {
        transform: translateX(0);
        opacity: 1;
      }
      to {
        transform: translateX(100%);
        opacity: 0;
      }
    }

    /* Responsive */
    @media (max-width: 1024px) {
      .checkout-layout {
        grid-template-columns: 1fr;
      }

      .order-summary {
        position: static;
      }
    }
  </style>
</head>
<body>
<!-- Include Header -->
<div th:insert="~{frontend-fragments/header :: header}"></div>

<!-- Breadcrumb -->
<div class="breadcrumb-section">
  <div class="container">
    <ul class="breadcrumb">
      <li><a th:href="@{/}"><i class="fas fa-home"></i> Trang chủ</a></li>
      <li><a th:href="@{/cart}">Giỏ hàng</a></li>
      <li><span>Thanh toán</span></li>
    </ul>
  </div>
</div>

<!-- Page Title -->
<div class="page-title">
  <div class="container">
    <h1><i class="fas fa-credit-card"></i> Thanh toán đơn hàng</h1>
    <p>Vui lòng kiểm tra thông tin và hoàn tất đơn hàng</p>
  </div>
</div>

<!-- Main Content -->
<div class="container">
  <div class="checkout-layout">
    <!-- Left: Forms -->
    <div>
      <!-- 1. Địa chỉ giao hàng -->
      <div class="form-section">
        <h3 class="section-title">
          <i class="fas fa-map-marker-alt"></i>
          Địa chỉ giao hàng
        </h3>

        <div class="address-list" th:if="${!#lists.isEmpty(addresses)}">
          <div th:each="addr, iterStat : ${addresses}"
               class="address-item"
               th:classappend="${iterStat.index == 0} ? 'selected' : ''"
               onclick="selectAddress(this)">
            <input type="radio"
                   name="addressId"
                   th:value="${addr.addressId}"
                   th:checked="${iterStat.index == 0}">
            <div class="address-name">
              <span th:text="${addr.receiverName}">Nguyễn Văn A</span>
              <span class="address-default" th:if="${addr.isDefault}">Mặc định</span>
            </div>
            <div class="address-phone" th:text="${addr.phone}">0912345678</div>
            <div class="address-detail">
              <span th:text="${addr.address}">123 Nguyễn Huệ</span>
              <span th:if="${addr.ward}" th:text="', ' + ${addr.ward}"></span>
              <span th:if="${addr.district}" th:text="', ' + ${addr.district}"></span>
              <span th:if="${addr.province}" th:text="', ' + ${addr.province}"></span>
            </div>
          </div>
        </div>

        <button class="btn-add-address" onclick="toggleNewAddressForm()">
          <i class="fas fa-plus"></i> Thêm địa chỉ mới
        </button>

        <div class="new-address-form" id="newAddressForm">
          <div class="form-group">
            <label>Tên người nhận *</label>
            <input type="text" id="newReceiverName" required>
          </div>
          <div class="form-group">
            <label>Số điện thoại *</label>
            <input type="tel" id="newReceiverPhone" required>
          </div>
          <div class="form-group">
            <label>Địa chỉ chi tiết *</label>
            <input type="text" id="newAddress" required>
          </div>
          <div class="form-group">
            <label>Phường/Xã</label>
            <input type="text" id="newWard">
          </div>
          <div class="form-group">
            <label>Quận/Huyện</label>
            <input type="text" id="newDistrict">
          </div>
          <div class="form-group">
            <label>Tỉnh/Thành phố</label>
            <input type="text" id="newProvince">
          </div>
          <button class="btn-add-address" onclick="saveNewAddress()">
            <i class="fas fa-save"></i> Lưu địa chỉ
          </button>
        </div>
      </div>

      <!-- 2. Phương thức thanh toán -->
      <div class="form-section">
        <h3 class="section-title">
          <i class="fas fa-wallet"></i>
          Phương thức thanh toán
        </h3>

        <div class="payment-methods">
          <div class="payment-item selected" onclick="selectPayment(this)">
            <input type="radio" name="paymentMethod" value="COD" checked>
            <div class="payment-icon">
              <i class="fas fa-money-bill-wave" style="color: #4CAF50;"></i>
            </div>
            <div class="payment-info">
              <div class="payment-name">Thanh toán khi nhận hàng (COD)</div>
              <div class="payment-desc">Thanh toán bằng tiền mặt khi nhận hàng</div>
            </div>
          </div>

          <div class="payment-item" onclick="selectPayment(this)">
            <input type="radio" name="paymentMethod" value="VNPAY">
            <div class="payment-icon">
              <i class="fas fa-credit-card" style="color: #0066cc;"></i>
            </div>
            <div class="payment-info">
              <div class="payment-name">VNPay</div>
              <div class="payment-desc">Thanh toán qua VNPay (ATM, Visa, MasterCard)</div>
            </div>
          </div>

<!--          <div class="payment-item" onclick="selectPayment(this)">-->
<!--            <input type="radio" name="paymentMethod" value="MOMO">-->
<!--            <div class="payment-icon">-->
<!--              <i class="fas fa-mobile-alt" style="color: #d82d8b;"></i>-->
<!--            </div>-->
<!--            <div class="payment-info">-->
<!--              <div class="payment-name">MoMo</div>-->
<!--              <div class="payment-desc">Thanh toán qua ví điện tử MoMo</div>-->
<!--            </div>-->
<!--          </div>-->
        </div>
      </div>

      <!-- 3. Mã giảm giá & Điểm tích lũy -->
      <div class="form-section">
        <h3 class="section-title">
          <i class="fas fa-gift"></i>
          Mã giảm giá & Điểm tích lũy
        </h3>

        <div class="coupon-section">
          <input type="text" class="coupon-input" id="couponInput"
                 th:value="${appliedPromoCode}"
                 placeholder="Nhập mã giảm giá">
          <button class="btn-apply-coupon" onclick="applyCoupon()">
            <i class="fas fa-tag"></i> Áp dụng
          </button>
        </div>

        <div class="loyalty-section" th:if="${customer.loyaltyPoints > 0}">
          <div class="loyalty-info">
            <span><i class="fas fa-star"></i> Bạn có <strong th:text="${customer.loyaltyPoints}">0</strong> điểm tích lũy</span>
            <span style="color: #666; font-size: 13px;">(1 điểm = 1,000đ)</span>
          </div>
          <div class="loyalty-checkbox">
            <input type="checkbox" id="useLoyaltyPoints" onchange="toggleLoyaltyInput()">
            <label for="useLoyaltyPoints">Sử dụng điểm tích lũy</label>
            <input type="number"
                   class="loyalty-input"
                   id="loyaltyPointsInput"
                   min="0"
                   th:max="${customer.loyaltyPoints}"
                   value="0"
                   disabled
                   onchange="recalculateTotal()">
          </div>
        </div>
      </div>

      <!-- 4. Ghi chú -->
      <div class="form-section">
        <h3 class="section-title">
          <i class="fas fa-comment"></i>
          Ghi chú đơn hàng
        </h3>

        <div class="form-group">
          <textarea id="orderNote" placeholder="Ghi chú về đơn hàng, ví dụ: thời gian hay chỉ dẫn địa điểm giao hàng chi tiết hơn"></textarea>
        </div>
      </div>
    </div>

    <!-- Right: Order Summary -->
    <div class="order-summary">
      <h3 class="summary-title">Đơn hàng của bạn</h3>

      <div class="summary-items">
        <div th:each="item : ${cartItems}" class="summary-item">
          <div class="item-image">
            <img th:if="${item.device.imageUrl}"
                 th:src="${item.device.imageUrl}"
                 th:alt="${item.device.name}">
            <i th:unless="${item.device.imageUrl}"
               class="fas fa-heartbeat"
               style="font-size: 30px; color: #ccc; display: flex; align-items: center; justify-content: center; height: 100%;"></i>
          </div>
          <div class="item-details">
            <div class="item-name" th:text="${item.device.name}">Sản phẩm</div>
            <div class="item-qty">Số lượng: <span th:text="${item.quantity}">1</span></div>
          </div>
          <div class="item-price"
               th:text="${@helper.formatPrice(@helper.calculateDiscountPrice(item.device.price.doubleValue(), item.device.discountPercent.doubleValue()) * item.quantity)}">
            0đ
          </div>
        </div>
      </div>

      <div class="summary-row">
        <span>Tạm tính:</span>
        <span id="subtotalAmount" th:text="${@helper.formatPrice(subtotal.doubleValue())}">0đ</span>
      </div>

      <div class="summary-row">
        <span>Phí vận chuyển:</span>
        <span id="shippingAmount" th:text="${@helper.formatPrice(shippingFee.doubleValue())}">0đ</span>
      </div>

      <div class="summary-row" id="discountRow" th:style="${discountAmount != null and discountAmount > 0} ? 'display: flex;' : 'display: none;'">
        <span>Giảm giá:</span>
        <span id="discountAmount" style="color: #4CAF50;"
              th:text="${discountAmount != null ? '-' + @helper.formatPrice(discountAmount.doubleValue()) : '0đ'}">0đ</span>
      </div>

      <div class="summary-row" id="loyaltyRow" style="display: none;">
        <span>Dùng điểm tích lũy:</span>
        <span id="loyaltyAmount" style="color: #4CAF50;">0đ</span>
      </div>

      <div class="summary-row total">
        <span>Tổng cộng:</span>
        <span id="totalAmount" th:text="${@helper.formatPrice(total.doubleValue())}">0đ</span>
      </div>

      <button class="btn-place-order" onclick="placeOrder()">
        <i class="fas fa-check-circle"></i> Đặt hàng
      </button>
    </div>
  </div>
</div>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
  <div class="loading-spinner"></div>
</div>

<!-- Include Footer -->
<div th:insert="~{frontend-fragments/footer :: footer}"></div>

<script th:inline="javascript">
  /*<![CDATA[*/
  // ==================== GLOBAL VARIABLES ====================
  let subtotal = /*[[${subtotal.doubleValue()}]]*/ 0;
  let shippingFee = /*[[${shippingFee.doubleValue()}]]*/ 0;
  let discountAmount = /*[[${discountAmount != null ? discountAmount.doubleValue() : 0}]]*/ 0;
  let loyaltyDiscount = 0;
  let promotionId = null;
  let customerLoyaltyPoints = /*[[${customer.loyaltyPoints}]]*/ 0;
  let appliedPromoCode = /*[[${appliedPromoCode}]]*/ '';

  // ==================== INIT - Hiển thị discount nếu có ====================
  document.addEventListener('DOMContentLoaded', function() {
    console.log('Checkout page loaded');
    console.log('Subtotal:', subtotal);
    console.log('Shipping fee:', shippingFee);
    console.log('Discount amount:', discountAmount);
    console.log('Applied promo code:', appliedPromoCode);
    console.log('Customer loyalty points:', customerLoyaltyPoints);

    // Hiển thị discount nếu có
    if (discountAmount > 0) {
      document.getElementById('discountRow').style.display = 'flex';
      document.getElementById('discountAmount').textContent = '-' + formatPrice(discountAmount);
    }

    // Tính lại tổng tiền
    recalculateTotal();
  });

  // ==================== ADDRESS FUNCTIONS ====================
  function selectAddress(element) {
    document.querySelectorAll('.address-item').forEach(item => {
      item.classList.remove('selected');
    });
    element.classList.add('selected');
    element.querySelector('input[type="radio"]').checked = true;
  }

  function toggleNewAddressForm() {
    const form = document.getElementById('newAddressForm');
    form.classList.toggle('active');
  }

  async function saveNewAddress() {
    const receiverName = document.getElementById('newReceiverName').value.trim();
    const phone = document.getElementById('newReceiverPhone').value.trim();
    const address = document.getElementById('newAddress').value.trim();
    const ward = document.getElementById('newWard').value.trim();
    const district = document.getElementById('newDistrict').value.trim();
    const province = document.getElementById('newProvince').value.trim();

    if (!receiverName || !phone || !address) {
      showNotification('Vui lòng điền đầy đủ thông tin bắt buộc', 'error');
      return;
    }

    showLoading();

    try {
      const response = await fetch('/checkout/add-address', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          receiverName: receiverName,
          phone: phone,
          address: address,
          ward: ward,
          district: district,
          province: province
        })
      });

      const result = await response.json();

      if (result.success) {
        showNotification(result.message, 'success');
        setTimeout(() => {
          window.location.reload();
        }, 1500);
      } else {
        showNotification(result.message, 'error');
      }
    } catch (error) {
      console.error('Error:', error);
      showNotification('Có lỗi xảy ra!', 'error');
    } finally {
      hideLoading();
    }
  }

  // ==================== PAYMENT FUNCTIONS ====================
  function selectPayment(element) {
    document.querySelectorAll('.payment-item').forEach(item => {
      item.classList.remove('selected');
    });
    element.classList.add('selected');
    element.querySelector('input[type="radio"]').checked = true;
  }

  // ==================== COUPON FUNCTIONS ====================
  async function applyCoupon() {
    const code = document.getElementById('couponInput').value.trim();

    if (!code) {
      showNotification('Vui lòng nhập mã giảm giá', 'error');
      return;
    }

    showLoading();

    try {
      const response = await fetch('/checkout/apply-coupon', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          code: code,
          orderAmount: subtotal
        })
      });

      const result = await response.json();

      if (result.success) {
        discountAmount = result.discountAmount;
        promotionId = result.promotionId;

        document.getElementById('discountRow').style.display = 'flex';
        document.getElementById('discountAmount').textContent = '-' + formatPrice(discountAmount);

        recalculateTotal();
        showNotification(result.message, 'success');
      } else {
        showNotification(result.message, 'error');
      }
    } catch (error) {
      console.error('Error:', error);
      showNotification('Có lỗi xảy ra!', 'error');
    } finally {
      hideLoading();
    }
  }

  // ==================== LOYALTY POINTS FUNCTIONS ====================
  function toggleLoyaltyInput() {
    const checkbox = document.getElementById('useLoyaltyPoints');
    const input = document.getElementById('loyaltyPointsInput');

    if (checkbox.checked) {
      input.disabled = false;
      input.value = Math.min(customerLoyaltyPoints, Math.floor(subtotal / 1000));
    } else {
      input.disabled = true;
      input.value = 0;
    }

    recalculateTotal();
  }

  // ==================== CALCULATION FUNCTIONS ====================
  function recalculateTotal() {
    // Tính loyalty discount
    const loyaltyPointsUsed = parseInt(document.getElementById('loyaltyPointsInput').value) || 0;
    loyaltyDiscount = loyaltyPointsUsed * 1000;

    // Hiển thị loyalty discount
    if (loyaltyPointsUsed > 0) {
      document.getElementById('loyaltyRow').style.display = 'flex';
      document.getElementById('loyaltyAmount').textContent = '-' + formatPrice(loyaltyDiscount);
    } else {
      document.getElementById('loyaltyRow').style.display = 'none';
    }

    // Tính tổng
    let total = subtotal + shippingFee - discountAmount - loyaltyDiscount;
    if (total < 0) total = 0;

    document.getElementById('totalAmount').textContent = formatPrice(total);
  }

  // ==================== PLACE ORDER ====================
  async function placeOrder() {
    // Get selected address
    const selectedAddressRadio = document.querySelector('input[name="addressId"]:checked');

    if (!selectedAddressRadio) {
      showNotification('Vui lòng chọn địa chỉ giao hàng', 'error');
      return;
    }

    // Get selected payment method
    const selectedPaymentRadio = document.querySelector('input[name="paymentMethod"]:checked');

    if (!selectedPaymentRadio) {
      showNotification('Vui lòng chọn phương thức thanh toán', 'error');
      return;
    }

    const addressId = parseInt(selectedAddressRadio.value);
    const paymentMethod = selectedPaymentRadio.value;
    const note = document.getElementById('orderNote').value.trim();

    // Lấy loyalty points - kiểm tra checkbox trước
    const useLoyaltyCheckbox = document.getElementById('useLoyaltyPoints');
    const loyaltyPointsUsed = (useLoyaltyCheckbox && useLoyaltyCheckbox.checked)
            ? (parseInt(document.getElementById('loyaltyPointsInput').value) || 0)
            : 0;

    const promotionCode = document.getElementById('couponInput').value.trim();

    // Get selected address details
    const selectedAddress = selectedAddressRadio.closest('.address-item');

    // Lấy receiverName - chỉ lấy text đầu tiên, bỏ qua badge "Mặc định"
    const addressNameSpan = selectedAddress.querySelector('.address-name span:first-child');
    const receiverName = addressNameSpan ? addressNameSpan.textContent.trim() :
            selectedAddress.querySelector('.address-name').childNodes[0].textContent.trim();

    const receiverPhone = selectedAddress.querySelector('.address-phone').textContent.trim();
    const receiverAddress = selectedAddress.querySelector('.address-detail').textContent.trim();

    console.log('=== PLACE ORDER DEBUG ===');
    console.log('Address ID:', addressId);
    console.log('Receiver Name:', receiverName);
    console.log('Receiver Phone:', receiverPhone);
    console.log('Receiver Address:', receiverAddress);
    console.log('Payment Method:', paymentMethod);
    console.log('Promotion Code:', promotionCode);
    console.log('Loyalty Points Used:', loyaltyPointsUsed);
    console.log('Note:', note);

    showLoading();

    try {
      const requestBody = {
        addressId: addressId,
        receiverName: receiverName,
        receiverPhone: receiverPhone,
        receiverAddress: receiverAddress,
        paymentMethod: paymentMethod,
        promotionCode: promotionCode || null,
        loyaltyPointsUsed: loyaltyPointsUsed,
        note: note
      };

      console.log('Request Body:', JSON.stringify(requestBody, null, 2));

      const response = await fetch('/checkout/place-order', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(requestBody)
      });

      console.log('Response Status:', response.status);

      const result = await response.json();
      console.log('Response Result:', result);

      if (result.success) {
        // ✅ FIX: Kiểm tra payment method để quyết định hành động
        if (result.paymentMethod === 'VNPAY') {
          // Đối với VNPay: Không hiện thông báo thành công, chuyển ngay sang trang thanh toán
          console.log('Redirecting to VNPay payment...');
          window.location.href = '/payment/vnpay?orderId=' + result.orderId;
        } else {
          // Đối với COD: Hiện thông báo thành công
          showNotification(result.message, 'success');
          setTimeout(() => {
            window.location.href = '/order-success?orderCode=' + result.orderCode;
          }, 1500);
        }
      } else {
        showNotification(result.message || 'Có lỗi xảy ra khi đặt hàng', 'error');
        hideLoading();
      }
    } catch (error) {
      console.error('Error:', error);
      showNotification('Có lỗi xảy ra khi đặt hàng! ' + error.message, 'error');
      hideLoading();
    }
  }

  // ==================== HELPER FUNCTIONS ====================
  function formatPrice(price) {
    return new Intl.NumberFormat('vi-VN').format(price) + ' đ';
  }

  function showLoading() {
    document.getElementById('loadingOverlay').classList.add('active');
  }

  function hideLoading() {
    document.getElementById('loadingOverlay').classList.remove('active');
  }

  function showNotification(message, type = 'success') {
    const toast = document.createElement('div');
    toast.className = `notification-toast ${type}`;
    toast.innerHTML = `
      <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'}"
         style="font-size: 24px; color: ${type === 'success' ? '#4CAF50' : '#ff4444'};"></i>
      <div style="flex: 1;">
        <div style="font-weight: 600;">${type === 'success' ? 'Thành công!' : 'Thông báo'}</div>
        <div style="font-size: 13px; color: #666;">${message}</div>
      </div>
      <i class="fas fa-times" style="cursor: pointer;" onclick="this.parentElement.remove()"></i>
    `;

    document.body.appendChild(toast);

    setTimeout(() => {
      toast.style.animation = 'slideOutRight 0.3s ease-out';
      setTimeout(() => toast.remove(), 300);
    }, 4000);
  }

  // ==================== HELPER FUNCTIONS ====================
  function formatPrice(price) {
    return new Intl.NumberFormat('vi-VN').format(price) + ' đ';
  }

  function showLoading() {
    document.getElementById('loadingOverlay').classList.add('active');
  }

  function hideLoading() {
    document.getElementById('loadingOverlay').classList.remove('active');
  }

  function showNotification(message, type = 'success') {
    const toast = document.createElement('div');
    toast.className = `notification-toast ${type}`;
    toast.innerHTML = `
      <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'}"
         style="font-size: 24px; color: ${type === 'success' ? '#4CAF50' : '#ff4444'};"></i>
      <div style="flex: 1;">
        <div style="font-weight: 600;">${type === 'success' ? 'Thành công!' : 'Thông báo'}</div>
        <div style="font-size: 13px; color: #666;">${message}</div>
      </div>
      <i class="fas fa-times" style="cursor: pointer;" onclick="this.parentElement.remove()"></i>
    `;

    document.body.appendChild(toast);

    setTimeout(() => {
      toast.style.animation = 'slideOutRight 0.3s ease-out';
      setTimeout(() => toast.remove(), 300);
    }, 4000);
  }
  /*]]>*/
</script>

</body>
</html>