<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/admin-layout}">
<head>
    <title>Qu·∫£n l√Ω ƒê∆°n h√†ng</title>

    <style>
        .stats-card {
            border-left: 4px solid #007bff;
        }

        .order-code {
            font-weight: bold;
            color: #007bff;
        }

        .customer-info small {
            color: #666;
        }

        .badge-status {
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 13px;
        }

        .status-pending { background: #ffc107; color: #fff; }
        .status-confirmed { background: #17a2b8; color: #fff; }
        .status-preparing { background: #6f42c1; color: #fff; }
        .status-shipping { background: #007bff; color: #fff; }
        .status-completed { background: #28a745; color: #fff; }
        .status-cancelled { background: #dc3545; color: #fff; }
        .status-returned { background: #6c757d; color: #fff; }
    </style>
</head>

<body>
<h1 layout:fragment="page-title">üì¶ Qu·∫£n l√Ω ƒê∆°n h√†ng</h1>

<ol class="breadcrumb float-sm-right" layout:fragment="breadcrumb">
    <li class="breadcrumb-item"><a href="/admin/dashboard">Home</a></li>
    <li class="breadcrumb-item active">ƒê∆°n h√†ng</li>
</ol>

<section layout:fragment="content">
    <div class="container-fluid">

        <!-- ===================== STATISTICS ===================== -->
        <div class="row mb-3">
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="card-body">
                        <h6>T·ªïng ƒë∆°n h√†ng</h6>
                        <h2 th:text="${stats.totalOrders}">0</h2>
                    </div>
                </div>
            </div>

            <div class="col-md-3">
                <div class="card stats-card" style="border-color: #ffc107;">
                    <div class="card-body">
                        <h6>ƒêang ch·ªù x·ª≠ l√Ω</h6>
                        <h2 class="text-warning" th:text="${stats.pendingOrders}">0</h2>
                    </div>
                </div>
            </div>

            <div class="col-md-3">
                <div class="card stats-card" style="border-color: #28a745;">
                    <div class="card-body">
                        <h6>Ho√†n th√†nh</h6>
                        <h2 class="text-success" th:text="${stats.completedOrders}">0</h2>
                    </div>
                </div>
            </div>

            <div class="col-md-3">
                <div class="card stats-card" style="border-color: #dc3545;">
                    <div class="card-body">
                        <h6>ƒê√£ h·ªßy</h6>
                        <h2 class="text-danger" th:text="${stats.cancelledOrders}">0</h2>
                    </div>
                </div>
            </div>
        </div>

        <!-- ===================== FILTER ===================== -->
        <div class="card mb-3">
            <div class="card-body">
                <form class="form-inline" method="get" action="/admin/orders">

                    <input type="text" name="search" class="form-control mr-2 mb-2"
                           placeholder="T√¨m m√£ ƒë∆°n / t√™n kh√°ch..."
                           th:value="${keyword}" style="min-width: 260px">

                    <!-- Status -->
                    <select name="status" class="form-control mr-2 mb-2">
                        <option value="">-- Tr·∫°ng th√°i --</option>
                        <option value="PENDING" th:selected="${status == 'PENDING'}">Ch·ªù x√°c nh·∫≠n</option>
                        <option value="CONFIRMED" th:selected="${status == 'CONFIRMED'}">ƒê√£ x√°c nh·∫≠n</option>
                        <option value="PREPARING" th:selected="${status == 'PREPARING'}">ƒêang chu·∫©n b·ªã</option>
                        <option value="SHIPPING" th:selected="${status == 'SHIPPING'}">ƒêang giao</option>
                        <option value="COMPLETED" th:selected="${status == 'COMPLETED'}">Ho√†n th√†nh</option>
                        <option value="CANCELLED" th:selected="${status == 'CANCELLED'}">ƒê√£ h·ªßy</option>
                    </select>

                    <!-- Payment -->
                    <select name="payment" class="form-control mr-2 mb-2">
                        <option value="">-- Thanh to√°n --</option>
                        <option value="COD" th:selected="${paymentMethod == 'COD'}">COD</option>
                        <option value="VNPAY" th:selected="${paymentMethod == 'VNPAY'}">VNPay</option>
                        <option value="MOMO" th:selected="${paymentMethod == 'MOMO'}">Momo</option>
                    </select>

                    <!-- Date from -->
                    <input type="date" name="from" class="form-control mr-2 mb-2"
                           th:value="${fromDate}">

                    <!-- Date to -->
                    <input type="date" name="to" class="form-control mr-2 mb-2"
                           th:value="${toDate}">

                    <button class="btn btn-primary mr-2 mb-2">
                        <i class="fas fa-search"></i> L·ªçc
                    </button>

                    <a href="/admin/orders" class="btn btn-secondary mb-2">
                        <i class="fas fa-redo"></i> Reset
                    </a>
                </form>
            </div>
        </div>

        <!-- ===================== TABLE ===================== -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h3 class="card-title mb-0">
                    Danh s√°ch ƒë∆°n h√†ng
                    <span class="badge badge-primary ml-2" th:text="${totalItems}">0</span>
                </h3>
                <button id="deleteSelectedBtn" class="btn btn-danger btn-sm" disabled>
                    <i class="fas fa-trash-alt"></i> X√≥a ƒë√£ ch·ªçn
                    (<span id="selectedCount">0</span>)
                </button>
            </div>

            <div class="card-body table-responsive p-0">
                <table class="table table-hover align-middle">
                    <thead>
                    <tr>
                        <th><input type="checkbox" id="selectAll"></th>
                        <th>M√£ ƒë∆°n</th>
                        <th>Kh√°ch h√†ng</th>
                        <th>T·ªïng ti·ªÅn</th>
                        <th>Thanh to√°n</th>
                        <th>Tr·∫°ng th√°i</th>
                        <th>Ng√†y t·∫°o</th>
                        <th class="text-center">Thao t√°c</th>
                    </tr>
                    </thead>

                    <tbody>
                    <tr th:each="o : ${orders}">
                        <td><input type="checkbox" class="selectOrder" th:value="${o.orderId}"></td>

                        <td>
                            <span class="order-code" th:text="${o.orderCode}"></span>
                        </td>

                        <td class="customer-info">
                            <strong th:text="${o.customer.fullName}">Nguyen Van A</strong>
                            <br>
                            <small th:text="${o.customer.email}"></small>
                        </td>

                        <td>
                            <strong th:text="${#numbers.formatDecimal(o.totalPrice, 0, 'COMMA', 0, 'POINT')} + '‚Ç´'"></strong>
                        </td>

                        <td>
                            <span class="badge badge-info" th:text="${o.paymentMethod}"></span><br>
                            <small th:text="${o.paymentStatus}"></small>
                        </td>

                        <td>
                            <span class="badge-status"
                                  th:classappend="${'status-' + o.status.name().toLowerCase()}"
                                  th:text="${o.status.value}">
                            </span>
                        </td>

                        <td>
                            <small th:text="${#temporals.format(o.createdAt, 'dd/MM/yyyy HH:mm')}"></small>
                        </td>

                        <td class="text-center">
                            <div class="btn-group btn-group-sm">
                                <a th:href="@{/admin/orders/view/{id}(id=${o.orderId})}" class="btn btn-info">
                                    <i class="fas fa-eye"></i>
                                </a>

                                <button class="btn btn-danger btn-delete"
                                        th:attr="data-id=${o.orderId}">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </div>
                        </td>
                    </tr>

                    <tr th:if="${#lists.isEmpty(orders)}">
                        <td colspan="8" class="text-center text-muted py-5">
                            <i class="fas fa-box-open fa-3x mb-3"></i>
                            <p>Kh√¥ng t√¨m th·∫•y ƒë∆°n h√†ng n√†o</p>
                        </td>
                    </tr>

                    </tbody>
                </table>
            </div>

            <!-- PAGINATION -->
            <div class="card-footer d-flex justify-content-between align-items-center">
                <div>
                    <span>
                        Trang <strong th:text="${currentPage + 1}"></strong> /
                        <strong th:text="${totalPages}"></strong>
                    </span>

                    <span class="ml-2">
                        T·ªïng: <strong th:text="${totalItems}">0</strong> ƒë∆°n
                    </span>
                </div>

                <nav>
                    <ul class="pagination mb-0">
                        <li class="page-item" th:classappend="${currentPage == 0} ? 'disabled'">
                            <a class="page-link" th:href="@{/admin/orders(page=0)}">&laquo;</a>
                        </li>

                        <li class="page-item" th:classappend="${currentPage == 0} ? 'disabled'">
                            <a class="page-link" th:href="@{/admin/orders(page=${currentPage - 1})}">Tr∆∞·ªõc</a>
                        </li>

                        <li class="page-item"
                            th:each="i : ${#numbers.sequence(0, totalPages - 1)}"
                            th:classappend="${i == currentPage} ? 'active'">
                            <a class="page-link" th:text="${i + 1}"
                               th:href="@{/admin/orders(page=${i})}"></a>
                        </li>

                        <li class="page-item" th:classappend="${currentPage + 1 >= totalPages} ? 'disabled'">
                            <a class="page-link" th:href="@{/admin/orders(page=${currentPage + 1})}">Sau</a>
                        </li>

                        <li class="page-item" th:classappend="${currentPage + 1 >= totalPages} ? 'disabled'">
                            <a class="page-link" th:href="@{/admin/orders(page=${totalPages - 1})}">&raquo;</a>
                        </li>
                    </ul>
                </nav>
            </div>
        </div>

    </div>
</section>

<th:block layout:fragment="scripts">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        const selectAll = document.getElementById('selectAll');
        const orderCheckboxes = document.querySelectorAll('.selectOrder');
        const deleteSelectedBtn = document.getElementById('deleteSelectedBtn');
        const selectedCountSpan = document.getElementById('selectedCount');

        function updateDeleteButton() {
            const checked = Array.from(orderCheckboxes).filter(c => c.checked).length;
            selectedCountSpan.textContent = checked;
            deleteSelectedBtn.disabled = checked === 0;
        }

        selectAll.addEventListener('change', () => {
            orderCheckboxes.forEach(c => c.checked = selectAll.checked);
            updateDeleteButton();
        });

        orderCheckboxes.forEach(c => c.addEventListener('change', updateDeleteButton));

        // Delete single
        document.querySelectorAll('.btn-delete').forEach(btn => {
            btn.addEventListener('click', () => {
                const id = btn.getAttribute('data-id');

                Swal.fire({
                    title: 'X√≥a ƒë∆°n h√†ng?',
                    text: 'H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    confirmButtonText: 'X√≥a'
                }).then(r => {
                    if (r.isConfirmed) {
                        fetch('/admin/orders/delete/' + id, {
                            method: 'DELETE'
                        })
                            .then(res => res.json())
                            .then(data => {
                                if (data.success) {
                                    Swal.fire('Th√†nh c√¥ng!', data.message, 'success')
                                        .then(() => location.reload());
                                } else {
                                    Swal.fire('L·ªói', data.message, 'error');
                                }
                            });
                    }
                });

            });
        });

        // Delete selected
        deleteSelectedBtn.addEventListener('click', () => {
            const ids = Array.from(orderCheckboxes).filter(c => c.checked).map(c => c.value);

            if (ids.length === 0) return;

            Swal.fire({
                title: 'X√≥a ' + ids.length + ' ƒë∆°n h√†ng?',
                text: 'Kh√¥ng th·ªÉ ho√†n t√°c.',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                confirmButtonText: 'X√≥a t·∫•t c·∫£'
            }).then(r => {
                if (r.isConfirmed) {
                    fetch('/admin/orders/delete-batch', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(ids)
                    })
                        .then(res => res.json())
                        .then(data => {
                            if (data.success) {
                                Swal.fire('ƒê√£ x√≥a!', data.message, 'success')
                                    .then(() => location.reload());
                            } else {
                                Swal.fire('L·ªói', data.message, 'error');
                            }
                        });
                }
            });
        });
    </script>

</th:block>

</body>
</html>
