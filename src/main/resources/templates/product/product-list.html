<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/admin-layout}">
<head>
    <title>Qu·∫£n l√Ω S·∫£n ph·∫©m</title>
</head>
<style>
    .pagination .page-item.active .page-link {
        background-color: #293a58;
        border-color: #293a58;
    }
    .page-link {
        color: #293a58;
    }
    .page-link:hover {
        background-color: #e9ecef;
    }
    .product-image {
        width: 50px !important;
        height: 50px !important;
        object-fit: cover !important;
        border-radius: 6px;
        border: 1px solid #dee2e6;
    }
    .price-info {
        display: flex;
        flex-direction: column;
    }
    .price-original {
        text-decoration: line-through;
        color: #6c757d;
        font-size: 0.85rem;
    }
    .price-current {
        color: #dc3545;
        font-weight: bold;
    }
    table {
        table-layout: fixed;
    }
    table td img.product-image {
        width: 50px !important;
        height: 50px !important;
        max-width: 50px !important;
        max-height: 50px !important;
        object-fit: cover !important;
        display: block !important;
    }
    td:nth-child(4) {
        max-width: 300px;
        white-space: normal !important;
        word-break: break-word;
    }
</style>
<body>
<h1 layout:fragment="page-title">üì¶ Qu·∫£n l√Ω S·∫£n ph·∫©m</h1>

<ol class="breadcrumb float-sm-right" layout:fragment="breadcrumb">
    <li class="breadcrumb-item"><a href="/admin/dashboard">Home</a></li>
    <li class="breadcrumb-item active">S·∫£n ph·∫©m</li>
</ol>

<section layout:fragment="content">
    <div class="container-fluid">

        <!-- Filter & Actions -->
        <div class="row mb-3">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <form class="form-inline" method="get" action="/admin/products" id="filterForm">
                            <input type="text" name="search" class="form-control mr-2 mb-2"
                                   placeholder="T√¨m theo t√™n, SKU..." th:value="${searchKeyword}"
                                   style="min-width: 250px;">

                            <select name="categoryId" class="form-control mr-2 mb-2">
                                <option value="">-- Danh m·ª•c --</option>
                                <option th:each="cat : ${categories}"
                                        th:value="${cat.categoryId}"
                                        th:text="${cat.name}"
                                        th:selected="${categoryId == cat.categoryId}">
                                </option>
                            </select>

                            <select name="brandId" class="form-control mr-2 mb-2">
                                <option value="">-- Th∆∞∆°ng hi·ªáu --</option>
                                <option th:each="brand : ${brands}"
                                        th:value="${brand.brandId}"
                                        th:text="${brand.name}"
                                        th:selected="${brandId == brand.brandId}">
                                </option>
                            </select>

                            <select name="status" class="form-control mr-2 mb-2">
                                <option value="">-- Tr·∫°ng th√°i --</option>
                                <option value="C√≤n_h√†ng" th:selected="${status == 'C√≤n_h√†ng'}">C√≤n h√†ng</option>
                                <option value="H·∫øt_h√†ng" th:selected="${status == 'H·∫øt_h√†ng'}">H·∫øt h√†ng</option>
                                <option value="Ng·ª´ng_b√°n" th:selected="${status == 'Ng·ª´ng_b√°n'}">Ng·ª´ng b√°n</option>
                            </select>

                            <button type="submit" class="btn btn-primary mr-2 mb-2">
                                <i class="fas fa-search"></i> T√¨m ki·∫øm
                            </button>
                            <a href="/admin/products" class="btn btn-secondary mr-2 mb-2">
                                <i class="fas fa-redo"></i> Reset
                            </a>
                            <a href="/admin/products/add" class="btn btn-success ml-auto mb-2">
                                <i class="fas fa-plus"></i> Th√™m s·∫£n ph·∫©m
                            </a>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Products Table -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h3 class="card-title mb-0 d-flex align-items-center">
                            Danh s√°ch s·∫£n ph·∫©m
                            <span class="badge badge-primary ml-2" th:text="${totalItems}">0</span>
                        </h3>
                        <div class="d-flex align-items-center">
                            <button id="deleteSelectedBtn" class="btn btn-danger btn-sm" disabled>
                                <i class="fas fa-trash-alt mr-1"></i>
                                X√≥a ƒë√£ ch·ªçn (<span id="selectedCount">0</span>)
                            </button>
                        </div>
                    </div>

                    <div class="card-body table-responsive p-0">
                        <table class="table table-hover align-middle">
                            <thead>
                            <tr>
                                <th style="width: 40px;">
                                    <input type="checkbox" id="selectAll">
                                </th>
                                <th>H√¨nh ·∫£nh</th>
                                <th>M√£ SP</th>
                                <th style="max-width: 300px;">T√™n s·∫£n ph·∫©m</th>
                                <th>Danh m·ª•c</th>
                                <th>Th∆∞∆°ng hi·ªáu</th>
                                <th>Gi√° B√°n - Gi√° G·ªëc</th>
                                <th>T·ªìn kho</th>
                                <th>ƒê√£ b√°n</th>
                                <th>Tr·∫°ng th√°i</th>
                                <th class="text-center" style="width: 100px;">Thao t√°c</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr th:each="product : ${products}">
                                <td>
                                    <input type="checkbox"
                                           class="selectProduct"
                                           th:value="${product.deviceId}"
                                           th:attr="data-name=${product.name}">
                                </td>
                                <td>
                                    <img th:src="${product.imageUrl != null ? product.imageUrl : '/img/no-image.png'}"
                                         class="product-image"
                                         th:alt="${product.name}">
                                </td>
                                <td>
                                    <span class="badge badge-secondary" th:text="${product.sku}"></span>
                                </td>
                                <td>
                                    <div>
                                        <strong th:text="${product.name}">T√™n s·∫£n ph·∫©m</strong>
                                        <div class="text-muted small" th:if="${product.isFeatured}">
                                            <i class="fas fa-star text-warning"></i>
                                        </div>
                                        <div class="text-muted small" th:if="${product.isNew}">
                                            <i class="fas fa-certificate text-success"></i>
                                        </div>
                                    </div>
                                </td>
                                <td th:text="${product.categoryName ?: 'N/A'}"></td>
                                <td th:text="${product.brandName ?: 'N/A'}"></td>
                                <td>
                                    <div class="price-info">
                                        <span class="price-current" th:text="${#numbers.formatDecimal(product.price, 0, 'COMMA', 0, 'POINT')} + ' ƒë'">
                                        </span>
                                        <span class="price-original"
                                              th:if="${product.originalPrice != null && product.originalPrice > product.price}"
                                              th:text="${#numbers.formatDecimal(product.originalPrice, 0, 'COMMA', 0, 'POINT')} + ' ƒë' ">
                                        </span>
                                        <span class="badge badge-danger badge-sm"
                                              th:if="${product.discountPercent != null && product.discountPercent > 0}"
                                              th:text="'-' + ${product.discountPercent} + '%'">
                                        </span>
                                    </div>
                                </td>
                                <td>
                                    <span th:class="${'badge ' + (product.stockQuantity <= product.minStockLevel ? 'badge-danger' : 'badge-success')}"
                                          th:text="${product.stockQuantity}">
                                        50
                                    </span>
                                </td>
                                <td>
                                    <span class="badge badge-info" th:text="${product.soldCount ?: 0}">0</span>
                                </td>
                                <td>
                                    <span th:class="${'badge ' +
                                        (product.status == 'C√≤n_h√†ng' ? 'badge-success' :
                                         (product.status == 'H·∫øt_h√†ng' ? 'badge-warning' :
                                         'badge-secondary'))}"
                                          th:text="${product.status ?: 'N/A'}">
                                        C√≤n h√†ng
                                    </span>

                                </td>
                                <td class="text-center">
                                    <div class="btn-group" role="group">
                                        <a th:href="@{/admin/products/edit/{id}(id=${product.deviceId})}"
                                           class="btn btn-sm btn-warning"
                                           title="Ch·ªânh s·ª≠a">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        <button type="button"
                                                class="btn btn-sm btn-danger btn-delete"
                                                th:attr="data-id=${product.deviceId},data-name=${product.name}"
                                                title="X√≥a">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>

                            <tr th:if="${#lists.isEmpty(products)}">
                                <td colspan="11" class="text-center text-muted py-5">
                                    <i class="fas fa-box-open fa-3x mb-3"></i>
                                    <p>Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m n√†o</p>
                                </td>
                            </tr>
                            </tbody>
                        </table>

                        <!-- Pagination -->
                        <div class="card-footer d-flex justify-content-between align-items-center">
                            <div>
                                <span>Trang <strong th:text="${currentPage + 1}">1</strong> / <strong th:text="${totalPages}">1</strong></span>
                                <span class="ml-2">T·ªïng s·ªë: <strong th:text="${totalItems}">0</strong> s·∫£n ph·∫©m</span>
                            </div>

                            <nav>
                                <ul class="pagination mb-0">
                                    <li class="page-item" th:classappend="${currentPage == 0} ? 'disabled'">
                                        <a class="page-link" th:href="@{/admin/products(page=0, search=${searchKeyword}, categoryId=${categoryId}, brandId=${brandId}, status=${status})}">&laquo;</a>
                                    </li>

                                    <li class="page-item" th:classappend="${currentPage == 0} ? 'disabled'">
                                        <a class="page-link"
                                           th:href="@{/admin/products(page=${currentPage - 1}, search=${searchKeyword}, categoryId=${categoryId}, brandId=${brandId}, status=${status})}">
                                            Tr∆∞·ªõc
                                        </a>
                                    </li>

                                    <li class="page-item"
                                        th:each="i : ${#numbers.sequence(0, totalPages - 1)}"
                                        th:classappend="${i == currentPage} ? 'active'">
                                        <a class="page-link"
                                           th:text="${i + 1}"
                                           th:href="@{/admin/products(page=${i}, search=${searchKeyword}, categoryId=${categoryId}, brandId=${brandId}, status=${status})}">
                                        </a>
                                    </li>

                                    <li class="page-item" th:classappend="${currentPage + 1 >= totalPages} ? 'disabled'">
                                        <a class="page-link"
                                           th:href="@{/admin/products(page=${currentPage + 1}, search=${searchKeyword}, categoryId=${categoryId}, brandId=${brandId}, status=${status})}">
                                            Sau
                                        </a>
                                    </li>

                                    <li class="page-item" th:classappend="${currentPage + 1 >= totalPages} ? 'disabled'">
                                        <a class="page-link" th:href="@{/admin/products(page=${totalPages - 1}, search=${searchKeyword}, categoryId=${categoryId}, brandId=${brandId}, status=${status})}">&raquo;</a>
                                    </li>
                                </ul>
                            </nav>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal x√≥a ƒë∆°n -->
    <div class="modal fade" id="deleteSingleModal" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-exclamation-triangle mr-2"></i>X√°c nh·∫≠n x√≥a s·∫£n ph·∫©m
                    </h5>
                    <button type="button" class="close text-white" data-dismiss="modal">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="text-center mb-3">
                        <i class="fas fa-box-open fa-3x text-danger"></i>
                    </div>
                    <p class="text-center mb-2">B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a s·∫£n ph·∫©m:</p>
                    <h5 class="text-center text-primary" id="productNameToDelete"></h5>
                    <div class="alert alert-warning mt-3">
                        <i class="fas fa-info-circle mr-2"></i>
                        <small>H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">
                        <i class="fas fa-times mr-1"></i>H·ªßy
                    </button>
                    <button type="button" id="confirmDeleteBtn" class="btn btn-danger">
                        <i class="fas fa-trash mr-1"></i>X√≥a ngay
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal x√≥a nhi·ªÅu -->
    <div class="modal fade" id="deleteBatchModal" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-exclamation-triangle mr-2"></i>X√°c nh·∫≠n x√≥a nhi·ªÅu s·∫£n ph·∫©m
                    </h5>
                    <button type="button" class="close text-white" data-dismiss="modal">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="text-center mb-3">
                        <i class="fas fa-boxes fa-3x text-danger"></i>
                    </div>
                    <p class="text-center mb-3">
                        B·∫°n ƒëang chu·∫©n b·ªã x√≥a <strong class="text-danger" id="batchDeleteCount">0</strong> s·∫£n ph·∫©m:
                    </p>
                    <div class="border rounded p-3 bg-light" style="max-height: 200px; overflow-y: auto;">
                        <ul id="productListToDelete" class="mb-0 pl-3">
                        </ul>
                    </div>
                    <div class="alert alert-danger mt-3 mb-0">
                        <i class="fas fa-exclamation-circle mr-2"></i>
                        <strong>C·∫£nh b√°o:</strong> H√†nh ƒë·ªông n√†y s·∫Ω x√≥a vƒ©nh vi·ªÖn t·∫•t c·∫£ s·∫£n ph·∫©m ƒë√£ ch·ªçn v√† kh√¥ng th·ªÉ ho√†n t√°c!
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">
                        <i class="fas fa-times mr-1"></i>H·ªßy
                    </button>
                    <button type="button" id="confirmBatchDeleteBtn" class="btn btn-danger">
                        <i class="fas fa-trash-alt mr-1"></i>X√≥a t·∫•t c·∫£
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal th√¥ng b√°o l·ªói -->
    <div class="modal fade" id="errorModal" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-times-circle mr-2"></i>L·ªói x·∫£y ra
                    </h5>
                    <button type="button" class="close text-white" data-dismiss="modal">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="text-center mb-3">
                        <i class="fas fa-exclamation-triangle fa-4x text-warning"></i>
                    </div>
                    <h5 class="text-center mb-3" id="errorTitle">C√≥ l·ªói x·∫£y ra</h5>
                    <div class="alert alert-danger">
                        <p class="mb-0" id="errorMessage">ƒê√£ c√≥ l·ªói x·∫£y ra trong qu√° tr√¨nh x·ª≠ l√Ω.</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-dismiss="modal">
                        <i class="fas fa-check mr-1"></i>ƒê√£ hi·ªÉu
                    </button>
                </div>
            </div>
        </div>
    </div>
</section>

<th:block layout:fragment="scripts">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            'use strict';

            let productToDelete = null;
            let productNameToDelete = null;

            function showErrorModal(title, message) {
                document.getElementById('errorTitle').textContent = title;
                document.getElementById('errorMessage').textContent = message;
                $('#errorModal').modal('show');
            }

            function confirmDelete(id, name) {
                productToDelete = id;
                productNameToDelete = name;
                document.getElementById('productNameToDelete').textContent = name;
                $('#deleteSingleModal').modal('show');
            }

            // Single Delete
            const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
            if (confirmDeleteBtn) {
                confirmDeleteBtn.addEventListener('click', function () {
                    if (!productToDelete) return;

                    const btn = this;
                    btn.disabled = true;
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>ƒêang x√≥a...';

                    fetch('/admin/products/delete/' + productToDelete, {
                        method: 'DELETE',
                        headers: {'Content-Type': 'application/json'}
                    })
                        .then(res => res.ok ? res.json() : res.json().then(err => { throw new Error(err.message || 'X√≥a th·∫•t b·∫°i'); }))
                        .then(data => {
                            $('#deleteSingleModal').modal('hide');
                            Swal.fire({
                                icon: 'success',
                                title: 'ƒê√£ x√≥a!',
                                text: 'S·∫£n ph·∫©m "' + productNameToDelete + '" ƒë√£ ƒë∆∞·ª£c x√≥a th√†nh c√¥ng.',
                                timer: 2000,
                                showConfirmButton: false
                            }).then(() => location.reload());
                        })
                        .catch(err => {
                            btn.disabled = false;
                            btn.innerHTML = '<i class="fas fa-trash mr-1"></i>X√≥a ngay';
                            $('#deleteSingleModal').modal('hide');
                            showErrorModal('Kh√¥ng th·ªÉ x√≥a s·∫£n ph·∫©m', err.message || 'ƒê√£ x·∫£y ra l·ªói khi x√≥a s·∫£n ph·∫©m.');
                        });
                });
            }

            // Multiple Selection
            const deleteSelectedBtn = document.getElementById('deleteSelectedBtn');
            const selectAllCheckbox = document.getElementById('selectAll');
            const productCheckboxes = document.querySelectorAll('.selectProduct');
            const selectedCountSpan = document.getElementById('selectedCount');

            function updateDeleteButton() {
                const checkedBoxes = Array.from(productCheckboxes).filter(cb => cb.checked);
                selectedCountSpan.textContent = checkedBoxes.length;
                deleteSelectedBtn.disabled = checkedBoxes.length === 0;
            }

            if (selectAllCheckbox) {
                selectAllCheckbox.addEventListener('change', function () {
                    productCheckboxes.forEach(cb => cb.checked = selectAllCheckbox.checked);
                    updateDeleteButton();
                });
            }

            productCheckboxes.forEach(cb => cb.addEventListener('change', updateDeleteButton));

            if (deleteSelectedBtn) {
                deleteSelectedBtn.addEventListener('click', function () {
                    const checkedBoxes = Array.from(productCheckboxes).filter(cb => cb.checked);
                    const ids = checkedBoxes.map(cb => cb.value);
                    const names = checkedBoxes.map(cb => cb.getAttribute('data-name'));

                    if (ids.length === 0) return;

                    document.getElementById('batchDeleteCount').textContent = ids.length;
                    document.getElementById('productListToDelete').innerHTML = names.map(name =>
                        `<li class="mb-1"><i class="fas fa-box mr-2 text-muted"></i>${name}</li>`
                    ).join('');

                    $('#deleteBatchModal').modal('show');
                });
            }

            // Batch Delete
            const confirmBatchDeleteBtn = document.getElementById('confirmBatchDeleteBtn');
            if (confirmBatchDeleteBtn) {
                confirmBatchDeleteBtn.addEventListener('click', function () {
                    const checkedBoxes = Array.from(productCheckboxes).filter(cb => cb.checked);
                    const ids = checkedBoxes.map(cb => cb.value);

                    if (ids.length === 0) return;

                    const btn = this;
                    btn.disabled = true;
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>ƒêang x√≥a...';

                    fetch('/admin/products/delete-batch', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(ids)
                    })
                        .then(res => res.ok ? res.json() : res.json().then(err => { throw new Error(err.message || 'Kh√¥ng th·ªÉ x√≥a s·∫£n ph·∫©m'); }))
                        .then(data => {
                            $('#deleteBatchModal').modal('hide');
                            Swal.fire({
                                icon: 'success',
                                title: 'X√≥a th√†nh c√¥ng!',
                                text: 'ƒê√£ x√≥a ' + data.deletedCount + ' s·∫£n ph·∫©m.',
                                timer: 2000,
                                showConfirmButton: false
                            }).then(() => location.reload());
                        })
                        .catch(err => {
                            btn.disabled = false;
                            btn.innerHTML = '<i class="fas fa-trash-alt mr-1"></i>X√≥a t·∫•t c·∫£';
                            $('#deleteBatchModal').modal('hide');
                            showErrorModal('Kh√¥ng th·ªÉ x√≥a s·∫£n ph·∫©m', err.message || 'ƒê√£ x·∫£y ra l·ªói khi x√≥a nhi·ªÅu s·∫£n ph·∫©m.');
                        });
                });
            }

            // Reset buttons on modal close
            $('#deleteSingleModal, #deleteBatchModal').on('hidden.bs.modal', function () {
                if (confirmDeleteBtn) {
                    confirmDeleteBtn.disabled = false;
                    confirmDeleteBtn.innerHTML = '<i class="fas fa-trash mr-1"></i>X√≥a ngay';
                }
                if (confirmBatchDeleteBtn) {
                    confirmBatchDeleteBtn.disabled = false;
                    confirmBatchDeleteBtn.innerHTML = '<i class="fas fa-trash-alt mr-1"></i>X√≥a t·∫•t c·∫£';
                }
            });

            // Init delete buttons
            document.querySelectorAll('.btn-delete').forEach(function(btn) {
                const id = btn.getAttribute('data-id');
                const name = btn.getAttribute('data-name');
                btn.addEventListener('click', function (e) {
                    e.preventDefault();
                    confirmDelete(id, name);
                });
            });
        });
    </script>
</th:block>
</body>
</html>