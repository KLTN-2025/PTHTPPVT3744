<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout}">
<head>
    <title>Qu·∫£n l√Ω Nh√¢n vi√™n</title>
</head>
<style>
    .pagination .page-item.active .page-link {
        background-color: #293a58;
        border-color: #293a58;
    }
    .page-link {
        color: #293a58;
    }
    .page-link:hover {
        background-color: #e9ecef;
    }
</style>
<body>
<h1 layout:fragment="page-title">üë• Qu·∫£n l√Ω Nh√¢n Vi√™n</h1>

<ol class="breadcrumb float-sm-right" layout:fragment="breadcrumb">
    <li class="breadcrumb-item"><a href="/admin/dashboard">Home</a></li>
    <li class="breadcrumb-item active">Nh√¢n vi√™n</li>
</ol>

<section layout:fragment="content">
    <div class="container-fluid">

        <!-- Filter & Actions -->
        <div class="row mb-3">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <form class="form-inline" method="get" action="/admin/employees" id="filterForm">
                            <input type="text" name="search" class="form-control mr-2 mb-2"
                                   placeholder="T√¨m theo t√™n, m√£ NV, email..." th:value="${searchKeyword}"
                                   style="min-width: 250px;">
                            <select name="status" class="form-control mr-2 mb-2">
                                <option value="">-- Tr·∫°ng th√°i --</option>
                                <option value="ACTIVE" th:selected="${status == 'ACTIVE'}">ƒêang l√†m vi·ªác</option>
                                <option value="ON_LEAVE" th:selected="${status == 'ON_LEAVE'}">Ngh·ªâ ph√©p</option>
                                <option value="RESIGNED" th:selected="${status == 'RESIGNED'}">ƒê√£ ngh·ªâ vi·ªác</option>
                            </select>
                            <button type="submit" class="btn btn-primary mr-2 mb-2">
                                <i class="fas fa-search"></i> T√¨m ki·∫øm
                            </button>
                            <a href="/admin/employees" class="btn btn-secondary mr-2 mb-2">
                                <i class="fas fa-redo"></i> Reset
                            </a>
                            <a href="/admin/employees/add" class="btn btn-success ml-auto mb-2">
                                <i class="fas fa-plus"></i> Th√™m nh√¢n vi√™n
                            </a>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Employee Table -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h3 class="card-title mb-0 d-flex align-items-center">
                            Danh s√°ch nh√¢n vi√™n
                            <span class="badge badge-primary ml-2" th:text="${totalItems}">0</span>
                        </h3>
                        <div class="d-flex align-items-center">
                            <button id="deleteSelectedBtn" class="btn btn-danger btn-sm" disabled>
                                <i class="fas fa-trash-alt mr-1"></i>
                                X√≥a ƒë√£ ch·ªçn (<span id="selectedCount">0</span>)
                            </button>
                        </div>
                    </div>

                    <div class="card-body table-responsive p-0">
                        <table class="table table-hover text-nowrap align-middle">
                            <thead>
                            <tr>
                                <th style="width: 40px;">
                                    <input type="checkbox" id="selectAll">
                                </th>
                                <th>M√£ NV</th>
                                <th>H·ªç t√™n</th>
                                <th>Email</th>
                                <th>ƒêi·ªán tho·∫°i</th>
                                <th>Ph√≤ng ban</th>
                                <th>Ch·ª©c v·ª•</th>
                                <th>Vai tr√≤</th>
                                <th>Tr·∫°ng th√°i</th>
                                <th class="text-center" style="width: 100px;">Thao t√°c</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr th:each="employee : ${employees}">
                                <td>
                                    <input type="checkbox"
                                           class="selectEmployee"
                                           th:value="${employee.employeeId}"
                                           th:attr="data-name=${employee.fullName}">
                                </td>
                                <td th:text="${employee.employeeCode}">EMP001</td>
                                <td th:text="${employee.fullName}">Nguy·ªÖn VƒÉn A</td>
                                <td th:text="${employee.email}">email@example.com</td>
                                <td th:text="${employee.phone}">0123456789</td>
                                <td th:text="${employee.department ?: 'N/A'}">Ph√≤ng ban</td>
                                <td th:text="${employee.position ?: 'N/A'}">Ch·ª©c v·ª•</td>
                                <td>
                                    <span class="badge badge-info" th:text="${employee.roleName}">Role</span>
                                </td>
                                <td>
                                    <span th:class="${'badge ' +
                                        (employee.status == 'ACTIVE' ? 'badge-success' :
                                         (employee.status == 'ON_LEAVE' ? 'badge-warning' :
                                         (employee.status == 'RESIGNED' ? 'badge-secondary' : 'badge-danger')))}"
                                          th:text="${employee.status == 'ACTIVE' ? 'ƒêang l√†m vi·ªác' :
                                                    (employee.status == 'ON_LEAVE' ? 'Ngh·ªâ ph√©p' :
                                                    (employee.status == 'RESIGNED' ? 'ƒê√£ ngh·ªâ vi·ªác' : employee.status))}">
                                        Active
                                    </span>
                                </td>
                                <td class="text-center">
                                    <div class="btn-group" role="group">
                                        <a th:href="@{/admin/employees/edit/{id}(id=${employee.employeeId})}"
                                           class="btn btn-sm btn-warning"
                                           title="Ch·ªânh s·ª≠a">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        <button type="button"
                                                class="btn btn-sm btn-danger btn-delete"
                                                th:attr="data-id=${employee.employeeId},data-name=${employee.fullName}"
                                                title="X√≥a">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>

                            <tr th:if="${#lists.isEmpty(employees)}">
                                <td colspan="10" class="text-center text-muted py-5">
                                    <i class="fas fa-inbox fa-3x mb-3"></i>
                                    <p>Kh√¥ng t√¨m th·∫•y nh√¢n vi√™n n√†o</p>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                        <!-- Pagination -->
                        <div class="card-footer d-flex justify-content-between align-items-center">
                            <div>
                                <span>Trang <strong th:text="${currentPage + 1}">1</strong> / <strong th:text="${totalPages}">1</strong></span>
                                <span class="ml-2">T·ªïng s·ªë: <strong th:text="${totalItems}">0</strong> nh√¢n vi√™n</span>
                            </div>

                            <nav>
                                <ul class="pagination mb-0">
                                    <!-- N√∫t "Trang ƒë·∫ßu" -->
                                    <li class="page-item" th:classappend="${currentPage == 0} ? 'disabled'">
                                        <a class="page-link" th:href="@{/admin/employees(page=0)}">&laquo;</a>
                                    </li>

                                    <!-- N√∫t "Tr∆∞·ªõc" -->
                                    <li class="page-item" th:classappend="${currentPage == 0} ? 'disabled'">
                                        <a class="page-link"
                                           th:href="@{/admin/employees(page=${currentPage - 1}, search=${searchKeyword}, status=${status}, roleId=${roleId}, department=${department})}">
                                            Tr∆∞·ªõc
                                        </a>
                                    </li>

                                    <!-- C√°c s·ªë trang -->
                                    <li class="page-item"
                                        th:each="i : ${#numbers.sequence(0, totalPages - 1)}"
                                        th:classappend="${i == currentPage} ? 'active'">
                                        <a class="page-link"
                                           th:text="${i + 1}"
                                           th:href="@{/admin/employees(page=${i}, search=${searchKeyword}, status=${status}, roleId=${roleId}, department=${department})}">
                                        </a>
                                    </li>

                                    <!-- N√∫t "Sau" -->
                                    <li class="page-item" th:classappend="${currentPage + 1 >= totalPages} ? 'disabled'">
                                        <a class="page-link"
                                           th:href="@{/admin/employees(page=${currentPage + 1}, search=${searchKeyword}, status=${status}, roleId=${roleId}, department=${department})}">
                                            Sau
                                        </a>
                                    </li>

                                    <!-- N√∫t "Trang cu·ªëi" -->
                                    <li class="page-item" th:classappend="${currentPage + 1 >= totalPages} ? 'disabled'">
                                        <a class="page-link" th:href="@{/admin/employees(page=${totalPages - 1})}">&raquo;</a>
                                    </li>
                                </ul>
                            </nav>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal x√≥a ƒë∆°n -->
    <div class="modal fade" id="deleteSingleModal" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-exclamation-triangle mr-2"></i>X√°c nh·∫≠n x√≥a nh√¢n vi√™n
                    </h5>
                    <button type="button" class="close text-white" data-dismiss="modal">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="text-center mb-3">
                        <i class="fas fa-user-times fa-3x text-danger"></i>
                    </div>
                    <p class="text-center mb-2">B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a nh√¢n vi√™n:</p>
                    <h5 class="text-center text-primary" id="employeeNameToDelete"></h5>
                    <div class="alert alert-warning mt-3">
                        <i class="fas fa-info-circle mr-2"></i>
                        <small>H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">
                        <i class="fas fa-times mr-1"></i>H·ªßy
                    </button>
                    <button type="button" id="confirmDeleteBtn" class="btn btn-danger">
                        <i class="fas fa-trash mr-1"></i>X√≥a ngay
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal x√≥a nhi·ªÅu -->
    <div class="modal fade" id="deleteBatchModal" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-exclamation-triangle mr-2"></i>X√°c nh·∫≠n x√≥a nhi·ªÅu nh√¢n vi√™n
                    </h5>
                    <button type="button" class="close text-white" data-dismiss="modal">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="text-center mb-3">
                        <i class="fas fa-users-slash fa-3x text-danger"></i>
                    </div>
                    <p class="text-center mb-3">
                        B·∫°n ƒëang chu·∫©n b·ªã x√≥a <strong class="text-danger" id="batchDeleteCount">0</strong> nh√¢n vi√™n:
                    </p>
                    <div class="border rounded p-3 bg-light" style="max-height: 200px; overflow-y: auto;">
                        <ul id="employeeListToDelete" class="mb-0 pl-3">
                        </ul>
                    </div>
                    <div class="alert alert-danger mt-3 mb-0">
                        <i class="fas fa-exclamation-circle mr-2"></i>
                        <strong>C·∫£nh b√°o:</strong> H√†nh ƒë·ªông n√†y s·∫Ω x√≥a vƒ©nh vi·ªÖn t·∫•t c·∫£ nh√¢n vi√™n ƒë√£ ch·ªçn v√† kh√¥ng th·ªÉ ho√†n t√°c!
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">
                        <i class="fas fa-times mr-1"></i>H·ªßy
                    </button>
                    <button type="button" id="confirmBatchDeleteBtn" class="btn btn-danger">
                        <i class="fas fa-trash-alt mr-1"></i>X√≥a t·∫•t c·∫£
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal th√¥ng b√°o l·ªói -->
    <div class="modal fade" id="errorModal" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-times-circle mr-2"></i>L·ªói x·∫£y ra
                    </h5>
                    <button type="button" class="close text-white" data-dismiss="modal">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="text-center mb-3">
                        <i class="fas fa-exclamation-triangle fa-4x text-warning"></i>
                    </div>
                    <h5 class="text-center mb-3" id="errorTitle">C√≥ l·ªói x·∫£y ra</h5>
                    <div class="alert alert-danger">
                        <p class="mb-0" id="errorMessage">ƒê√£ c√≥ l·ªói x·∫£y ra trong qu√° tr√¨nh x·ª≠ l√Ω.</p>
                    </div>
                    <div id="errorDetails" class="mt-3" style="display: none;">
                        <h6 class="text-muted">Chi ti·∫øt l·ªói:</h6>
                        <pre class="bg-light p-3 rounded" style="font-size: 12px; max-height: 150px; overflow-y: auto;"><code id="errorDetailsContent"></code></pre>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-dismiss="modal">
                        <i class="fas fa-check mr-1"></i>ƒê√£ hi·ªÉu
                    </button>
                </div>
            </div>
        </div>
    </div>
</section>
<th:block layout:fragment="scripts">
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.min.js"></script>
    <script>
        console.log('=== SCRIPT FILE LOADED ===');

        document.addEventListener('DOMContentLoaded', function () {
            'use strict';

            console.log('=== DOM LOADED ===');
            console.log('jQuery loaded:', typeof jQuery !== 'undefined');
            console.log('Bootstrap loaded:', typeof $.fn.modal !== 'undefined');
            console.log('SweetAlert loaded:', typeof Swal !== 'undefined');

            let employeeToDelete = null;
            let employeeNameToDelete = null;

            function showErrorModal(title, message, details) {
                console.log('showErrorModal:', title, message);
                const titleEl = document.getElementById('errorTitle');
                const messageEl = document.getElementById('errorMessage');
                const detailsDiv = document.getElementById('errorDetails');
                const detailsContent = document.getElementById('errorDetailsContent');

                if (!titleEl || !messageEl) return;

                titleEl.textContent = title;
                messageEl.textContent = message;

                if (details && detailsContent) {
                    detailsContent.textContent = JSON.stringify(details, null, 2);
                    detailsDiv.style.display = 'block';
                } else if (detailsDiv) {
                    detailsDiv.style.display = 'none';
                }

                $('#errorModal').modal('show');
            }

            function confirmDelete(id, name) {
                console.log('=== confirmDelete called ===');
                console.log('ID:', id);
                console.log('Name:', name);

                employeeToDelete = id;
                employeeNameToDelete = name;

                const nameSpan = document.getElementById('employeeNameToDelete');
                const modal = document.getElementById('deleteSingleModal');

                console.log('Modal element exists:', modal !== null);
                console.log('Name span exists:', nameSpan !== null);

                if (nameSpan) nameSpan.textContent = name;

                if (modal) {
                    console.log('Showing modal...');
                    $('#deleteSingleModal').modal('show');
                } else {
                    console.error('Modal #deleteSingleModal not found!');
                }
            }

            // ---------------- SINGLE DELETE ----------------
            const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
            console.log('Confirm delete button found:', confirmDeleteBtn !== null);

            if (confirmDeleteBtn) {
                confirmDeleteBtn.addEventListener('click', function () {
                    console.log('=== Confirm delete clicked ===');
                    console.log('Employee to delete:', employeeToDelete);

                    if (!employeeToDelete) return;

                    const btn = this;
                    btn.disabled = true;
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>ƒêang x√≥a...';

                    console.log('Sending DELETE request to:', '/admin/employees/delete/' + employeeToDelete);

                    fetch('/admin/employees/delete/' + employeeToDelete, {
                        method: 'DELETE',
                        headers: {'Content-Type': 'application/json'}
                    })
                        .then(res => {
                            console.log('Response status:', res.status);
                            console.log('Response ok:', res.ok);
                            return res.ok ? res.json() : res.json().then(err => { throw new Error(err.message || 'X√≥a th·∫•t b·∫°i'); });
                        })
                        .then(data => {
                            console.log('Delete success:', data);
                            $('#deleteSingleModal').modal('hide');
                            Swal.fire({
                                icon: 'success',
                                title: 'ƒê√£ x√≥a!',
                                text: 'Nh√¢n vi√™n "' + employeeNameToDelete + '" ƒë√£ ƒë∆∞·ª£c x√≥a th√†nh c√¥ng.',
                                timer: 2000,
                                showConfirmButton: false
                            }).then(() => location.reload());
                        })
                        .catch(err => {
                            console.error('Delete error:', err);
                            btn.disabled = false;
                            btn.innerHTML = '<i class="fas fa-trash mr-1"></i>X√≥a ngay';
                            $('#deleteSingleModal').modal('hide');
                            showErrorModal(
                                'Kh√¥ng th·ªÉ x√≥a nh√¢n vi√™n',
                                err.message || 'ƒê√£ x·∫£y ra l·ªói khi x√≥a nh√¢n vi√™n. Vui l√≤ng th·ª≠ l·∫°i.',
                                {employeeId: employeeToDelete, error: err.toString()}
                            );
                        });
                });
            }

            // ---------------- MULTIPLE DELETE ----------------
            const deleteSelectedBtn = document.getElementById('deleteSelectedBtn');
            const selectAllCheckbox = document.getElementById('selectAll');
            const employeeCheckboxes = document.querySelectorAll('.selectEmployee');
            const selectedCountSpan = document.getElementById('selectedCount');

            console.log('Delete selected button found:', deleteSelectedBtn !== null);
            console.log('Select all checkbox found:', selectAllCheckbox !== null);
            console.log('Employee checkboxes count:', employeeCheckboxes.length);

            function updateDeleteButton() {
                if (!selectedCountSpan || !deleteSelectedBtn) return;
                const checkedBoxes = Array.from(employeeCheckboxes).filter(cb => cb.checked);
                const count = checkedBoxes.length;
                selectedCountSpan.textContent = count;
                deleteSelectedBtn.disabled = count === 0;
            }

            if (selectAllCheckbox) {
                selectAllCheckbox.addEventListener('change', function () {
                    employeeCheckboxes.forEach(cb => cb.checked = selectAllCheckbox.checked);
                    updateDeleteButton();
                });
            }

            employeeCheckboxes.forEach(cb => {
                cb.addEventListener('change', updateDeleteButton);
            });

            if (deleteSelectedBtn) {
                deleteSelectedBtn.addEventListener('click', function () {
                    console.log('=== Delete selected clicked ===');
                    const checkedBoxes = Array.from(employeeCheckboxes).filter(cb => cb.checked);
                    const ids = checkedBoxes.map(cb => cb.value);
                    const names = checkedBoxes.map(cb => cb.getAttribute('data-name'));

                    console.log('Selected IDs:', ids);
                    console.log('Selected names:', names);

                    if (ids.length === 0) return;

                    const batchCount = document.getElementById('batchDeleteCount');
                    const listContainer = document.getElementById('employeeListToDelete');

                    if (batchCount) batchCount.textContent = ids.length;
                    if (listContainer) {
                        const listHtml = names.map(name =>
                            `<li class="mb-1"><i class="fas fa-user mr-2 text-muted"></i>${name}</li>`
                        ).join('');
                        listContainer.innerHTML = listHtml;
                    }

                    $('#deleteBatchModal').modal('show');
                });
            }

            const confirmBatchDeleteBtn = document.getElementById('confirmBatchDeleteBtn');
            console.log('Confirm batch delete button found:', confirmBatchDeleteBtn !== null);

            if (confirmBatchDeleteBtn) {
                confirmBatchDeleteBtn.addEventListener('click', function () {
                    console.log('=== Confirm batch delete clicked ===');
                    const checkedBoxes = Array.from(employeeCheckboxes).filter(cb => cb.checked);
                    const ids = checkedBoxes.map(cb => cb.value);

                    console.log('Deleting employees:', ids);

                    if (ids.length === 0) return;

                    const btn = this;
                    btn.disabled = true;
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>ƒêang x√≥a...';

                    console.log('Sending POST request to /admin/employees/delete-batch');

                    fetch('/admin/employees/delete-batch', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(ids)
                    })
                        .then(res => {
                            console.log('Batch response status:', res.status);
                            return res.ok ? res.json() : res.json().then(err => { throw new Error(err.message || 'Kh√¥ng th·ªÉ x√≥a nh√¢n vi√™n'); });
                        })
                        .then(data => {
                            console.log('Batch delete success:', data);
                            $('#deleteBatchModal').modal('hide');
                            Swal.fire({
                                icon: 'success',
                                title: 'X√≥a th√†nh c√¥ng!',
                                text: 'ƒê√£ x√≥a ' + data.deletedCount + ' nh√¢n vi√™n.',
                                timer: 2000,
                                showConfirmButton: false
                            }).then(() => location.reload());
                        })
                        .catch(err => {
                            console.error('Batch delete error:', err);
                            btn.disabled = false;
                            btn.innerHTML = '<i class="fas fa-trash-alt mr-1"></i>X√≥a t·∫•t c·∫£';
                            $('#deleteBatchModal').modal('hide');
                            showErrorModal(
                                'Kh√¥ng th·ªÉ x√≥a nh√¢n vi√™n',
                                err.message || 'ƒê√£ x·∫£y ra l·ªói khi x√≥a nhi·ªÅu nh√¢n vi√™n. Vui l√≤ng th·ª≠ l·∫°i.',
                                {employeeIds: ids, error: err.toString()}
                            );
                        });
                });
            }

            // ---------------- RESET BUTTONS WHEN MODAL CLOSE ----------------
            $('#deleteSingleModal, #deleteBatchModal').on('hidden.bs.modal', function () {
                const deleteBtn = document.getElementById('confirmDeleteBtn');
                const batchDeleteBtn = document.getElementById('confirmBatchDeleteBtn');

                if (deleteBtn) {
                    deleteBtn.disabled = false;
                    deleteBtn.innerHTML = '<i class="fas fa-trash mr-1"></i>X√≥a ngay';
                }

                if (batchDeleteBtn) {
                    batchDeleteBtn.disabled = false;
                    batchDeleteBtn.innerHTML = '<i class="fas fa-trash-alt mr-1"></i>X√≥a t·∫•t c·∫£';
                }
            });

            // ---------------- INIT DELETE BUTTONS ----------------
            const deleteButtons = document.querySelectorAll('.btn-delete');
            console.log('=== Initializing delete buttons ===');
            console.log('Found delete buttons:', deleteButtons.length);

            deleteButtons.forEach(function(btn, index) {
                const id = btn.getAttribute('data-id');
                const name = btn.getAttribute('data-name');
                console.log(`Button ${index}:`, {id, name});

                btn.addEventListener('click', function (e) {
                    e.preventDefault();
                    console.log('=== DELETE BUTTON CLICKED ===');
                    console.log('Button index:', index);
                    console.log('ID:', id);
                    console.log('Name:', name);
                    confirmDelete(id, name);
                });
            });

            console.log('=== INITIALIZATION COMPLETE ===');
        });
    </script>
</th:block>
</body>
</html>